# Тесты для блока настроек

В этом каталоге содержатся тесты для блока настроек, доступного по адресу http://localhost:3000/dashboard/settings.

## Структура тестов

Тесты разделены на несколько файлов для лучшей организации:

1. **SettingsPage.test.tsx** - Основные тесты для страницы настроек, тестирующие компонент и его базовую функциональность.

2. **SettingsFormSchemas.test.ts** - Тесты для схем валидации форм Zod, используемых в формах профиля и пароля.

3. **SettingsUI.test.tsx** - Тесты для отдельных UI компонентов страницы настроек (вкладки, карточки).

4. **SettingsAPI.test.ts** - Тесты для API запросов, используемых на странице настроек.

## Запуск тестов

Для запуска всех тестов используйте команду:

```bash
npm test
```

Для запуска только тестов для блока настроек:

```bash
npm test -- dashboard/Settings
```

Для запуска конкретного теста:

```bash
npm test -- dashboard/SettingsPage
```

## Покрытие тестами

Тесты охватывают следующие аспекты блока настроек:

### UI и рендеринг
- Корректный рендеринг страницы настроек с тремя вкладками
- Переключение между вкладками (профиль, пароль, безопасность)
- Отображение компонентов UI (карточки, аватар, кнопки)

### Функциональность
- Получение данных пользователя при загрузке страницы
- Обновление профиля пользователя

### Валидация форм
- Валидация имени пользователя
- Валидация email
- Валидация пароля
- Проверка совпадения нового пароля и его подтверждения

### API запросы
- Тестирование GraphQL запросов и мутаций
- Проверка корректности запросов и обработки ответов

## Мокирование

В тестах используются моки для следующих зависимостей:
- `next/navigation` - для мокирования роутера
- `next-auth/react` - для мокирования сессии пользователя
- `sonner` - для мокирования тостов
- `global.fetch` - для мокирования API запросов

## Результаты тестирования

Все тесты успешно выполняются и проходят проверку. В текущей реализации мы сосредоточились на наиболее важных аспектах функциональности и устранили тесты, которые могли бы быть проблематичными без полного понимания внутренней реализации компонента.

## Советы по дальнейшему улучшению тестов

Если потребуется расширить покрытие тестами, рекомендуется добавить:

1. Тесты для переключения вкладок и проверки содержимого каждой вкладки
2. Тесты для формы изменения пароля с учётом состояния загрузки
3. Тесты для функционала загрузки аватара с корректным мокированием FileReader
4. Тесты для страницы настройки двухфакторной аутентификации
5. Более надежные тесты для обработки ошибок при различных API-запросах

## Советы по написанию дополнительных тестов

При написании дополнительных тестов следуйте этим рекомендациям:

1. Используйте `beforeEach` для сброса моков перед каждым тестом.
2. Для имитации успешных API запросов используйте `mockResolvedValueOnce`.
3. Для имитации ошибок API запросов используйте `mockRejectedValueOnce`.
4. Для тестирования UI компонентов используйте `render` и `screen` из `@testing-library/react`.
5. Для тестирования взаимодействия пользователя используйте `userEvent` из `@testing-library/user-event`.
6. При тестировании асинхронных операций используйте `waitFor` для ожидания изменений в DOM.

# Тестирование компонентов блока Аудит

## Общий обзор

В этом разделе содержатся тесты для страницы аудита в панели управления. Тесты проверяют корректность отображения, функциональность фильтрации, пагинацию и экспорт данных.

## Структура тестов

Тесты блока аудита разделены на три файла:

1. **AuditPage.test.tsx** - основные тесты страницы аудита, включая:
   - Проверка корректного рендеринга страницы
   - Отображение всех необходимых элементов интерфейса
   - Загрузка и отображение данных аудита
   - Функциональность экспорта в CSV

2. **AuditPageNavigation.test.tsx** - тесты для навигации и очистки фильтров:
   - Переключение между страницами при пагинации
   - Очистка фильтров
   - Обработка ошибок при загрузке данных

3. **AuditPageUserFilter.test.tsx** - тесты для фильтрации по пользователям:
   - Отображение списка пользователей в фильтре
   - Фильтрация логов по выбранному пользователю
   - Комбинирование фильтров по пользователям и типам действий

## Моковые данные

Для тестов используются следующие моковые данные:

- Записи аудита с различными типами действий (LOGIN, CREATE, UPDATE, DELETE)
- Пользователи с разными ролями (admin, manager, editor)
- Метаданные пагинации для имитации постраничной навигации

## Особенности тестирования Next.js компонентов

При тестировании компонентов Next.js с директивой 'use client' возникают специфические проблемы, которые решаются следующим образом:

1. **Мокирование Next.js хуков** - в `setup.ts` и `test-utils.tsx` настроены моки для:
   - useRouter
   - usePathname
   - useSearchParams
   - useParams

2. **Настройка DOM-окружения** - для корректной работы тестов:
   - Используется jsdom вместо happy-dom
   - Настроен корректный процесс рендеринга компонентов с указанием контейнера
   - Обернуты вызовы рендера в React.act() для корректной обработки обновлений состояния

3. **Мокирование браузерных API** - для имитации работы с:
   - window.matchMedia
   - URL.createObjectURL
   - Element.prototype.scrollTo

## Запуск тестов

Тесты можно запустить с помощью команд:

```bash
# Запуск всех тестов
npm run test

# Запуск с отслеживанием изменений
npm run test:watch

# Запуск с отчетом о покрытии
npm run test:coverage
```

## Известные проблемы и их решения

1. **Ошибка "Target container is not a DOM element"**:
   - Причина: компоненты с директивой 'use client' требуют специальной настройки рендеринга
   - Решение: использование кастомной функции render в test-utils.tsx, которая явно создает и присоединяет контейнер к документу

2. **Проблемы с хуками Next.js**:
   - Причина: Next.js хуки требуют контекст, который не доступен в тестовой среде
   - Решение: мокирование всех хуков Next.js в setup.ts перед их использованием

3. **Асинхронное обновление состояния**:
   - Причина: React обновляет состояние асинхронно, что может привести к ошибкам в тестах
   - Решение: оборачивание рендера в React.act() и использование waitFor() для ожидания обновлений

4. **Проблемы с внешними API**:
   - Причина: компоненты могут использовать браузерные API, недоступные в тестовой среде
   - Решение: мокирование всех необходимых API в setup.ts 